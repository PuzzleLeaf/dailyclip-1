<!DOCTYPE html>
<html lang="ko">
<head>
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta property="og:title" content="DAILY CLIP">
<meta property="og:description" content="앱에 대한 설명 들어갈 자리">
<meta property="og:image" content="">
<meta property="og:url" content="">
<link rel="stylesheet" href="css/common.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/style_list.css" type="text/css" />
<title>DAILY CLIP</title>
<script src="https://www.gstatic.com/firebasejs/4.4.0/firebase.js"></script>
<script src="https://code.jquery.com/jquery-latest.min.js" ></script>
<script>
	//Initialize Firebase
	// 파이어베이스 접근 설정
	var config = {
	  apiKey: "AIzaSyBlRXKU6mf9KGW1cqUNThHuQu825qKd0MA",
	  authDomain: "dailyclip-b64d3.firebaseapp.com",
	  databaseURL: "https://dailyclip-b64d3.firebaseio.com",
	  projectId: "dailyclip-b64d3",
	  storageBucket: "dailyclip-b64d3.appspot.com",
	  messagingSenderId: "753746341919"
	};

	firebase.initializeApp(config);

	var database = firebase.database();
	var databaseRef = firebase.database().ref('list/');	//list 참조
	var userEmail;	//사용자 이메일
	var userId;	//사용자 고유 아이디
	var articleNum; //클립 갯수
	var articleKey;	//클립 고유키
	
	firebase.auth().onAuthStateChanged(function(user) {
	 	if(user){
	 		userEmail = user.email;
			userId = user.uid;
			
			fnHideModal();	//메뉴 모달 숨기기
	 		fnLinkLoad(user.uid); //사용자 고유의 아이디를 사용한다.
			//fnLinkAdd();	//링크 추가
	 	}
	});

	/******************************* LINK LOAD *******************************/
	//해당 유저의 모든 클립 출력
	function fnLinkLoad(userID){

		articleNum = 0;
		$(".link_list").empty();	//link_list 내의 내용 삭제
		
		databaseRef.child(userID).on('value', snapshot => {
			snapshot.forEach(function(childSnapshot){

				++articleNum;	//링크 갯수 추가

				var articleText = "";
				var fnClickText = "onclick='fnLinkClick(" + '"' + childSnapshot.val().url + '"' + ");'";
				var fnMenuText = "onclick='fnMenuClick(" + '"' + childSnapshot.key + '"' + ");'";

				articleText += "<div class='article'>";
				//articleText += "<a href='#'><div class='img_thumb'" + fnClickText + "></div></a>";
				articleText += "<a href='#'><div class='img_thumb'"; 
				articleText += "id='img_thumb" + articleNum + "' " + fnMenuText + "></div></a>";

				articleText += "<div class='content'>";
				articleText += "<a href='#'> <h2 class='title_article'";
				articleText += "id='title_article" + articleNum + "' " + fnClickText + ">";
				articleText	+= childSnapshot.val().title + "<h2></a>";
				
				articleText += "<a href='#'><p class='content_article'";
				articleText += "id='content_article" + articleNum + "'" + fnClickText + ">";
				articleText += childSnapshot.val().description + "</p></a>";

				articleText += "<div class='source_area'>";
				articleText += "<span class='date_article' id='date_article" + articleNum + "'>";
				articleText += childSnapshot.val().savedDate + "</span>";
				articleText += "<span class='addr_article' id='addr_article" + articleNum + "'>";
				articleText += childSnapshot.val().url + "</span></div>";

				if(childSnapshot.val().bookMark == 'N'){
					articleText += "<span class='chk_list'><a href='#'>";
					articleText += "<img id='imgChk" + articleNum + "' src='images/chk_list.png' alt=''";
				}
				else{
					articleText += "<span class='chk_list'><a href='#'>";
					articleText += "<img id='imgChk" + articleNum + "' class='bookmark' src='images/chk_list_2.png' alt=''";
				}
				articleText += "onclick='fnLinkCheck(" + '"' + childSnapshot.key + '"' + ',"' + articleNum + '"' + ");'>";
				articleText += "</a></span></div></div>";

				$(".link_list").append(articleText);	//링크목록에 추가
			})
			$(".container").css('display','none');	//로딩 지우기
			$(".link_list").slideDown();	//링크 보이기
		});
	}

	//링크 클릭시 이벤트
	function fnLinkClick(url){

		//즐겨찾기 버튼을 클릭했다면 이벤트 무효화
	/*	if($('.chk_list').hasClass('clicked')){
			$('.chk_list').removeClass("clicked");
		}
		else{
		//링크 클릭시 해당 링크로 이동
			location.href = url;
		}*/
		
		location.href = url;
		//location.href = "view.html?link=" + linkKey;
	}

	/***************************** BOOKMARK LINK *****************************/
	//즐겨찾기 클릭시 이벤트
	function fnLinkCheck(key, articleId){

		//링크 버튼 클릭과 즐겨찾기 버튼 클릭 구분
		//$('.chk_list').addClass("clicked");

		//각 북마크의 고유 아이디
		var imgChkId = "#imgChk" + articleId;

		//즐겨찾기된 링크일 경우, 즐겨찾기 해제
		if($(imgChkId).hasClass('bookmark')){

			$(imgChkId).attr('src', 'images/chk_list.png');
			$(imgChkId).removeClass("bookmark");

			var data = {};
			databaseRef.child(userId).child(key).on('value', snapshot => {

				data = {
					bookMark : 'N',
					description : snapshot.val().description,
					fname : snapshot.val().fname,
					savedDate : snapshot.val().savedDate,
					title : snapshot.val().title,
					url : snapshot.val().url
				}
			});

			var updates = {};
			updates['/list/' + userId + '/' + key] = data;
			firebase.database().ref().update(updates);
		}
		else{
		//그렇지 않을 경우, 즐겨찾기 설정
			$(imgChkId).addClass("bookmark");
			$(imgChkId).attr('src', 'images/chk_list_2.png');

			var data = {};
			databaseRef.child(userId).child(key).on('value', snapshot => {

				data = {
					bookMark : 'Y',
					description : snapshot.val().description,
					fname : snapshot.val().fname,
					savedDate : snapshot.val().savedDate,
					title : snapshot.val().title,
					url : snapshot.val().url
				}
			});

			var updates = {};
			updates['/list/' + userId + '/' + key] = data;
			firebase.database().ref().update(updates);
		}
		var textSearch = $(".searchTxt").val();
		var disPlay = $(".searchTxt").css('display');

		if(textSearch && disPlay != "none"){
			//search link
			fnLinkSearch(userId,textSearch);
		}else{
			//링크 재출력
			fnLinkLoad(userId);
		}
	}

	/******************************* LINK ADD *******************************/
	//링크 추가
	function fnLinkAdd(){
		var newKey = databaseRef.child(userId).push().key;
		var data = {
				bookMark : 'N',
				description : "구글 홈페이지5",
				fname : "",
				savedDate : "2017.10.19",
				title : "Google5",
				url : "http://www.google.co.kr"
			}

		var updates = {};
		updates['/list/' + userId + '/' + newKey] = data;
		firebase.database().ref().update(updates);
	}
	
	/******************************* MENU MODAL *******************************/
	//메뉴 모달 숨기기
	function fnHideModal(){
		window.onclick = function(event) {
			if (event.target == modal) {
				modal.style.display = "none";
 			}
		}
	}
	
	//메뉴 모달 닫기
	function fnCloseModal(){
		$("#modal").css('display','none');
	}
	
	/******************************* LINK EDIT *******************************/
	//수정 모달 닫기
	function fnCloseEditModal(){
		$("#edit_modal").css('display','none');
	}
	
	//링크 삭제 & 수정 처리
	function fnMenuClick(key){
		
		articleKey = key;
		
		//모달 보이기
		$("#modal").css('display','block');
		
		//링크 삭제
		$("#remove_link").on('click', function(){
		
			var isDelOk = confirm("해당 링크를 삭제하시겠어요?");

            if(isDelOk == false){
				//메뉴 모달 닫기
                $("#modal").css('display','none');
				//삭제 이벤트 무효화
				$("#remove").unbind("click");
				return false;
            }
			else{
				//삭제
				firebase.database().ref().child('/list/' + userId + '/' + key).remove();
				//메뉴 모달 닫기
				$("#modal").css('display','none');
				//삭제 이벤트 무효화
				$("#remove").unbind("click");
				//링크 재출력
				fnLinkLoad(userId);
			}
        });
		
		//링크 수정 모달 열기
		$("#edit_link").on('click', function() {
		
			//메뉴 모달 닫기
            $("#modal").css('display','none');
			
			databaseRef.child(userId).child(key).on('value', function(snapshot){
				
				$("#title_edit").val(snapshot.val().title);
				$("#content_edit").val(snapshot.val().description);
			});
			
			//수정 모달 열기
			$("#edit_modal").css('display','block');
		});
	}
	
	//링크 수정
	function fnLinkEdit(){
		
		var editTitle = $("#title_edit").val();
		var editContent = $("#content_edit").val();
		
		var data = {};
		databaseRef.child(userId).child(articleKey).on('value', snapshot => {

			data = {
					bookMark : snapshot.val().bookMark,
					description : editContent,
					fname : snapshot.val().fname,
					savedDate : snapshot.val().savedDate,
					title : editTitle,
					url : snapshot.val().url
				}
		});

		var updates = {};
		updates['/list/' + userId + '/' + articleKey] = data;
		firebase.database().ref().update(updates);
		
		//수정 모달 닫기
		$("#edit_modal").css('display','none');
		//메뉴 모달 닫기
		$("#modal").css('display','none');
		//링크 고유키 초기화
		articleKey = null;
		//링크 재출력
		fnLinkLoad(userId);
	}
	
	/****************************** LINK SEARCH ******************************/
	//링크 검색 보이기
	function fnShowSearch(){
	
		var $show = $(".searchTxt").css('display');
        
		if($show == 'none'){
            $(".top_menu > h1").hide();
            $(".searchTxt").val('').fadeIn();
        }
		else{
            $(".top_menu > h1").fadeIn();
            $(".searchTxt").hide();
            fnLinkLoad(userId);
        }
	}
	
	//링크 검색 커서
	function fnKeyUpSearch(){
        
		var txt = $(".searchTxt").val();

        if(txt == ""){
			$(".list_search").empty();	//검색결과 지우기
            fnLinkLoad(userId);
        }
		else{
			fnLinkSearch(userId, txt);
        }
	}

	//링크 검색
	function fnLinkSearch(userID, txt){
	
		var searchText = "";
		var resultText = "";	//검색결과 텍스트
		articleNum = 0;
		$(".link_list").empty();
		$(".list_search").empty();
		
		databaseRef.child(userID).on('value',function(snapshot){
			snapshot.forEach(function(childSnapshot){
				if(childSnapshot.val().title.indexOf(txt) != -1){
					
					++articleNum;	//링크 갯수 추가

					var fnClickText = "onclick='fnLinkClick(" + '"' + childSnapshot.val().url + '"' + ");'";
					var fnMenuText = "onclick='fnMenuClick(" + '"' + childSnapshot.key + '"' + ");'";

					searchText += "<div class='article'>";
					//searchText += "<a href='#'><div class='img_thumb'" + fnClickText + "></div></a>";
					searchText += "<a href='#'><div class='img_thumb'"; 
					searchText += "id='img_thumb" + articleNum + "' " + fnMenuText + "></div></a>";

					searchText += "<div class='content'>";
					searchText += "<a href='#'> <h2 class='title_article'";
					searchText += "id='title_article" + articleNum + "' " + fnClickText + ">";
					searchText	+= childSnapshot.val().title + "<h2></a>";

					searchText += "<a href='#'><p class='content_article'";
					searchText += "id='content_article" + articleNum + "'" + fnClickText + ">";
					searchText += childSnapshot.val().description + "</p></a>";

					searchText += "<div class='source_area'>";
					searchText += "<span class='date_article' id='date_article" + articleNum + "'>";
					searchText += childSnapshot.val().savedDate + "</span>";
					searchText += "<span class='addr_article' id='addr_article" + articleNum + "'>";
					searchText += childSnapshot.val().url + "</span></div>";

					if(childSnapshot.val().bookMark == 'N'){
						searchText += "<span class='chk_list'><a href='#'>";
						searchText += "<img id='imgChk" + articleNum + "' src='images/chk_list.png' alt=''";
					}
					else{
						searchText += "<span class='chk_list'><a href='#'>";
						searchText += "<img id='imgChk" + articleNum + "' class='bookmark' src='images/chk_list_2.png' alt=''";
					}
			
					searchText += "onclick='fnLinkCheck(" + '"' + childSnapshot.key + '"' + ',"' + articleNum + '"' + ");'>";
					searchText += "</a></span></div></div>";
				}
			});
			$(".link_list").append(searchText);
			//검색결과창
			resultText = "'" + txt + "' 검색결과 " + articleNum + "개";
			$(".list_search").text(resultText);
			$(".search_container").css('display', 'block');
		});
	}
</script>
</head>
<body >
<div id="wrap">
	<div id="list">
		<div class="list_area">
			<div class="top_menu">
				<h1>DAILYCLIP</h1>
				<input type="text" class="searchTxt" placeholder="제목을 입력하세요" onkeyup="fnKeyUpSearch();">
				<span class="btn_prev"><a href="list.html"><img src="images/btn_prev.png" alt=""></a></span>
				<span class="btn_search" id="search" onclick="fnShowSearch();"><img src="images/btn_search.png" alt=""></span>
			</div>
			<div class="section">
				<!-- loading -->
                <div class="container">
                  <div class="box">
                      <div class="loader10"></div>
                  </div>
                </div>
				<!-- search result --> 
				<div class="search_container">
					<span class="list_search"></span>
					<span class="select_search">
						<select name="" id="">
							<option value="">최신순</option>
							<option>조회순</option>
						</select>
					<span>
				</div>
				<!-- link list -->
				<ul class="link_list" style="display:none;">
                </ul>
			</div>
			<div class="bottom_menu">
				<ul class="icon_bottom">
					<li class="home"><a href="#"><img src="images/btn_folder_home.png" alt=""></a></li>
					<li class="bookmark"><a href="bookmark_list.html"><img src="images/btn_bookmark.png" alt=""></a></li>
					<li class="folder"><a href="folder.html"><img src="images/btn_folder.png" alt=""></a></li>
					<li class="setting"><a href="set_page.html"><img src="images/btn_setting.png" alt=""></a></li>
				</ul>
			</div>
			<div class="add_article">
			</div>
		</div>
	</div>
</div>
<!-- menu(delete & edit) modal -->
<div id="modal" class="modal">
    <div class="modal-content">
		<span class="close" onclick="fnCloseModal();">&times;</span>
		<div>
			<ul>
				<li><a href="javascript:;" id="edit_link" class="menuTxt">링크 수정</a></li>
				<li><a href="javascript:;" id="remove_link" class="menuTxt">링크 삭제</a></li>
			</ul>
		</div>
    </div>
</div>
<!-- edit modal -->
<div id="edit_modal" class="modal">
    <div class="modal-content">
		<span class="close" onclick="fnCloseEditModal();">&times;</span>
		<div>
			<form>
				<ul id="edit_ul">
					<li class='editTxt'>링크 제목 <input type='text' id='title_edit'/></li>
					<li class='editTxt'>링크 내용 <input type='text' id='content_edit'/></li>
				</ul>
				<input type="submit" class="menuTxt" id="edit_article" value="수정하기" onclick="fnLinkEdit();" style=""/>
			</form>
		</div>
    </div>
</div>
</body>
</html>
